{% extends "base_app.html" %}

{% block page_title %}Recipient Lists{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; gap: 16px; margin-bottom: 24px;">
        <button class="btn btn-primary" onclick="showCreateList()">Create New List</button>
        <button class="btn btn-secondary" onclick="showUploadCSV()">Upload CSV</button>
    </div>
    
    <div class="grid grid-2">
        <!-- Create/Edit List -->
        <div class="card" id="list-editor" style="display: none;">
            <div class="card-header">
                <h3 class="card-title" id="editor-title">Create New List</h3>
            </div>
            
            <div class="form-group">
                <label class="form-label">List Name</label>
                <input type="text" id="list-name-input" class="form-input" placeholder="My Recipients">
            </div>
            
            <div style="margin-bottom: 16px;">
                <label class="form-label">Recipients</label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="email" id="recipient-email" class="form-input" placeholder="email@example.com" style="flex: 1;">
                    <input type="text" id="recipient-name" class="form-input" placeholder="Name (optional)" style="flex: 1;">
                    <button class="btn btn-primary" onclick="addRecipient()">Add</button>
                </div>
            </div>
            
            <div id="recipients-table" style="max-height: 400px; overflow-y: auto; border: 1px solid #E5E7EB; border-radius: 6px;">
                <table class="table" style="margin: 0;">
                    <thead style="position: sticky; top: 0; background: white;">
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th style="width: 60px;"></th>
                        </tr>
                    </thead>
                    <tbody id="recipients-tbody">
                        <tr>
                            <td colspan="3" style="text-align: center; color: #9CA3AF; padding: 32px;">
                                No recipients added yet
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 16px; display: flex; gap: 8px;">
                <button class="btn btn-primary" onclick="saveList()">Save List</button>
                <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
            </div>
        </div>
        
        <!-- CSV Upload -->
        <div class="card" id="csv-uploader" style="display: none;">
            <div class="card-header">
                <h3 class="card-title">Upload CSV</h3>
            </div>
            
            <div id="dropzone" class="dropzone" style="margin-bottom: 16px;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <div class="dropzone-text">Drop CSV file here or click to browse</div>
                <input type="file" id="file-input" accept=".csv" style="display: none;">
            </div>
            
            <div id="csv-preview" style="display: none;">
                <p style="font-size: 14px; color: #6B7280; margin-bottom: 8px;">Preview:</p>
                <div style="max-height: 200px; overflow: auto; border: 1px solid #E5E7EB; border-radius: 6px; padding: 12px; background: #F9FAFB; font-size: 13px; font-family: monospace;">
                    <div id="csv-content"></div>
                </div>
                
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">List Name</label>
                    <input type="text" id="csv-list-name" class="form-input" placeholder="Imported List">
                </div>
                
                <button class="btn btn-primary" onclick="saveCSVList()">Import List</button>
            </div>
        </div>
        
        <!-- Existing Lists -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Your Lists</h3>
            </div>
            
            <div id="lists-container">
                {% if lists %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Recipients</th>
                            <th>Created</th>
                            <th style="width: 120px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for list in lists %}
                        <tr>
                            <td><strong>{{ list.name }}</strong></td>
                            <td>{{ list.recipient_count }}</td>
                            <td>{{ list.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <button class="btn-icon" onclick="editList({{ list.id }})" title="Edit">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="btn-icon" onclick="deleteList({{ list.id }})" title="Delete">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="text-align: center; color: #9CA3AF; padding: 32px;">No lists yet. Create one to get started!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.dropzone {
    border: 2px dashed #D1D5DB;
    border-radius: 8px;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s;
}

.dropzone:hover {
    border-color: #2563EB;
}

.dropzone svg {
    color: #9CA3AF;
    margin-bottom: 16px;
}

.dropzone-text {
    color: #6B7280;
    font-size: 14px;
}

.btn-icon {
    background: none;
    border: none;
    padding: 4px;
    cursor: pointer;
    color: #6B7280;
    transition: color 0.15s;
}

.btn-icon:hover {
    color: #2563EB;
}
</style>

<script>
{% raw %}
let currentListId = null;
let recipients = [];
let csvData = null;

function showCreateList() {
    currentListId = null;
    recipients = [];
    document.getElementById('editor-title').textContent = 'Create New List';
    document.getElementById('list-name-input').value = '';
    document.getElementById('recipients-tbody').innerHTML = '<tr><td colspan="3" style="text-align: center; color: #9CA3AF; padding: 32px;">No recipients added yet</td></tr>';
    document.getElementById('list-editor').style.display = 'block';
    document.getElementById('csv-uploader').style.display = 'none';
}

function showUploadCSV() {
    document.getElementById('list-editor').style.display = 'none';
    document.getElementById('csv-uploader').style.display = 'block';
    document.getElementById('csv-preview').style.display = 'none';
}

function addRecipient() {
    const email = document.getElementById('recipient-email').value.trim();
    const name = document.getElementById('recipient-name').value.trim();
    
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    
    if (!email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    if (recipients.some(r => r.email === email)) {
        alert('This email is already in the list');
        return;
    }
    
    recipients.push({ email, name: name || '' });
    renderRecipients();
    
    document.getElementById('recipient-email').value = '';
    document.getElementById('recipient-name').value = '';
    document.getElementById('recipient-email').focus();
}

function removeRecipient(index) {
    recipients.splice(index, 1);
    renderRecipients();
}

function renderRecipients() {
    const tbody = document.getElementById('recipients-tbody');
    
    if (recipients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #9CA3AF; padding: 32px;">No recipients added yet</td></tr>';
        return;
    }
    
    tbody.innerHTML = recipients.map((r, i) => `
        <tr>
            <td>${r.email}</td>
            <td>${r.name || '-'}</td>
            <td>
                <button class="btn-icon" onclick="removeRecipient(${i})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </td>
        </tr>
    `).join('');
}

async function saveList() {
    const name = document.getElementById('list-name-input').value.trim();
    
    if (!name) {
        alert('Please enter a list name');
        return;
    }
    
    if (recipients.length === 0) {
        alert('Please add at least one recipient');
        return;
    }
    
    // Format rows to match expected structure
    const rows = recipients.map(r => ({
        email: r.email,
        data: { name: r.name }
    }));
    
    try {
        let response;
        if (currentListId) {
            // Update existing list
            response = await fetch(`/lists/${currentListId}/update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, rows })
            });
        } else {
            // Create new list
            response = await fetch('/lists/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, rows })
            });
        }
        
        const data = await response.json();
        
        if (data.success) {
            alert('List saved successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to save list'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function editList(listId) {
    try {
        const response = await fetch(`/lists/${listId}`);
        const data = await response.json();
        
        currentListId = listId;
        recipients = data.recipients.map(r => ({ email: r.email, name: r.name || '' }));
        
        document.getElementById('editor-title').textContent = 'Edit List: ' + data.name;
        document.getElementById('list-name-input').value = data.name;
        renderRecipients();
        
        document.getElementById('list-editor').style.display = 'block';
        document.getElementById('csv-uploader').style.display = 'none';
    } catch (e) {
        alert('Error loading list: ' + e.message);
    }
}

function cancelEdit() {
    document.getElementById('list-editor').style.display = 'none';
    currentListId = null;
    recipients = [];
}

async function deleteList(id) {
    if (!confirm('Are you sure you want to delete this list?')) return;
    
    try {
        const response = await fetch(`/lists/${id}`, { method: 'DELETE' });
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete list'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// CSV Upload
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('file-input');

dropzone.addEventListener('click', () => fileInput.click());

dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.style.borderColor = '#2563EB';
});

dropzone.addEventListener('dragleave', () => {
    dropzone.style.borderColor = '#D1D5DB';
});

dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.style.borderColor = '#D1D5DB';
    const file = e.dataTransfer.files[0];
    if (file) handleCSVFile(file);
});

fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleCSVFile(file);
});

function handleCSVFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const content = e.target.result;
        csvData = content;
        
        const lines = content.split('\n').slice(0, 5);
        document.getElementById('csv-content').textContent = lines.join('\n') + '\n...';
        document.getElementById('csv-preview').style.display = 'block';
    };
    reader.readAsText(file);
}

async function saveCSVList() {
    const name = document.getElementById('csv-list-name').value.trim();
    
    if (!name) {
        alert('Please enter a list name');
        return;
    }
    
    try {
        const parseRes = await fetch('/lists/parse', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ content: csvData })
        });
        
        const parseData = await parseRes.json();
        
        if (!parseData.success) {
            alert('Error parsing CSV: ' + (parseData.error || 'Invalid format'));
            return;
        }
        
        const createRes = await fetch('/lists/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, rows: parseData.rows })
        });
        
        const createData = await createRes.json();
        
        if (createData.success) {
            alert('List imported successfully!');
            location.reload();
        } else {
            alert('Error: ' + (createData.error || 'Failed to import list'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Allow Enter key to add recipient
document.getElementById('recipient-email').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('recipient-name').focus();
    }
});

document.getElementById('recipient-name').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addRecipient();
    }
});
{% endraw %}
</script>
{% endblock %}
